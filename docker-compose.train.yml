version: "3.9"

services:
  piper-train:
    image: nvcr.io/nvidia/pytorch:24.04-py3
    runtime: nvidia
    network_mode: host
    environment:
      - NVIDIA_VISIBLE_DEVICES=all
      - NVIDIA_DRIVER_CAPABILITIES=compute,utility
      - DEBIAN_FRONTEND=noninteractive
    ipc: host
    working_dir: /workspace/piper1-gpl
    volumes:
      - .:/workspace/piper1-gpl
      - D:\git\nik-v-local-talking-llm\actors\felix_mirage:/data
      - E:\git\piper\checkpoints:/checkpoints:ro
    command: >
      bash -lc "\
        apt-get update && \
        apt-get install -y build-essential cmake ninja-build espeak-ng python3-venv && \
        python3 -m venv /tmp/piper-venv && \
        source /tmp/piper-venv/bin/activate && \
        pip install --upgrade pip && \
        pip install -q -e .[train] && \
        ./build_monotonic_align.sh && \
        python3 setup.py build_ext --inplace && \
        python3 -m piper.train fit --data.voice_name felix_mirage --data.csv_path /data/datasets/elevenlabs/zWSsRd3J6WyZFl12aGMB/metadata.csv --data.audio_dir /data/datasets/elevenlabs/zWSsRd3J6WyZFl12aGMB/wavs --model.sample_rate 44100 --data.espeak_voice ru --data.cache_dir /data/.cache --data.config_path /data/felix_mirage.json --data.batch_size 28 --trainer.max_epochs 10000 --trainer.check_val_every_n_epoch 1
      "
